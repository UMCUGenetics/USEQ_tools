{% extends "useq_mail_template.html" %}
{% block content %}
{% set color_list1 = ['#ffff00','#0000ff'] %}
<table class='useq_table'>
  <tr> <td><b>project(s))</b></td>  <td>{{projects}}</td> </tr>
  <tr> <td><b>Run Name</b></td>  <td>{{run_dir}}</td> </tr>
</table>
<h3>Status</h3>
<table class='useq_table'>
  <tr>
    <th>Run Stats</th>
    <th>Run Archive</th>
  </tr>
  <tr>
    <td>{{status['run']['Stats']}}</td>
    <td>{{status['run']['Archive']}}</td>
  </tr>
</table>
<br>
<table class='useq_table'>
  <tr>
    <th>Project</th>
    <th>BCL-Only</th>
    <th>Demultiplexing</th>
    <th>Transfer Nextcloud</th>
    <th>Transfer HPC</th>
  </tr>
  {% for pid, pid_status in status['projects'].items() %}
    <tr>
      <td>{{pid}}</td>
      <td>{{pid_status['BCL-Only']}}</td>
      <td>{{pid_status['Demultiplexing']}}</td>
      <td>{{pid_status['Transfer-nc']}}</td>
      <td>{{pid_status['Transfer-hpc']}}</td>
    </tr>
  {% endfor %}
</table>
<br>
{% if summary_stats %}
<h3>Run Summary</h3>
<table class='useq_table'>
  <tr>
    <th><b>Level</b></th>
    <th><b>Yield (Gbp)</b></th>
    <th><b>Expected Yield (Gbp)</b></th>
    <th><b>% Aligned PhiX</b></th>
    <th><b>Error Rate</b></th>
    <th><b>Intensity C1</b></th>
    <th><b>%>=Q30</b></th>
    <th><b>% Occupied</b></th>
  </tr>
  {% for row in summary_stats['summary'] %}
  <tr>
    {% if 'Level' in row -%} <td>{{ row['Level'] }}</td> {% endif %}
    {% if 'Yield' in row -%} <td>{{ row['Yield'] }}</td> {% endif %}

    {% if 'Level' in row and row['Level'] == 'Read 1' %}
      <td>{{ "{:,.2f}".format(expected_yields['r1']) }}</td>
    {% elif 'Level' in row and ( row['Level'] == 'Read 3' or row['Level'] == 'Read 4') %}
      <td>{{ "{:,.2f}".format(expected_yields['r2']) }}</td>
    {% else %}
      <td>-</td>
    {% endif %}
    <!-- {% if 'Projected Yield' in row -%} <td>{{ row['Projected Yield'] }}</td> {% endif %} -->

    {% if 'Aligned' in row -%} <td>{{ row['Aligned'] }}</td> {% endif %}
    {% if 'Error Rate' in row -%} <td>{{ row['Error Rate'] }}</td> {% endif %}
    {% if 'Intensity C1' in row -%} <td>{{ row['Intensity C1'] }}</td> {% endif %}
    {% if '%>=Q30' in row -%} <td>{{ row['%>=Q30'] }}</td> {% endif %}
    {% if '% Occupied' in row -%} <td>{{ row['% Occupied'] }}</td> {% endif %}
  </tr>
  {% endfor %}
</table>
<br>
<table class='useq_table'>
  <tr>
    <th style="visibility: hidden;border: 0px" colspan="4"></th>
    <th colspan="2"><b>Yield (Gbp)</b></th>
    <th colspan="2"><b>% Q30</b></th>
  </tr>
  <tr>
    <!-- # print("Lane,Read,%>=Q30,Yield,Aligned,% Occupied") -->
    <th><b>Lane</b></th>
    <th><b>Project(s)</b></th>
    <th><b>% Aligned PhiX</b></th>
    <th><b>% Occupied</b></th>
    <th><b>Read 1</b></th>
    <th><b>Read 2</b></th>
    <th><b>Read 1</b></th>
    <th><b>Read 2</b></th>
  </tr>
  {% for lane, lane_data in summary_stats['all'].items() %}
    {% set lane = lane|int %}
    {% set read1 = lane_data.keys()|first %}
    {% set read2 = '' %}
    {% set phix = lane_data[read1]['Aligned']|float %}
    {% set occ = lane_data[read1]['% Occupied']|float %}
    {% set yield_r1 =  lane_data[read1]['Yield']|float %}
    {% set yield_r2 = '' %}
    {% set q30_r1 =  lane_data[read1]['%>=Q30']|float %}
    {% set q30_r2 = '' %}
    {% set expected_yield_r1 = expected_yields['r1'] / summary_stats['all'].keys()|length %}
    {% set expected_yield_r2 = '' %}
    {% if lane_data.keys()|length > 1 %}
      {% set read2 = lane_data.keys()|last %}
      {% set phix = (lane_data[read1]['Aligned']|float + lane_data[read2]['Aligned']|float)/2 %}
      {% set occ = (lane_data[read1]['% Occupied']|float + lane_data[read2]['% Occupied']|float)/2 %}
      {% set yield_r2 =  lane_data[read2]['Yield']|float %}
      {% set q30_r2 =  lane_data[read2]['%>=Q30']|float %}
      {% set expected_yield_r2 = expected_yields['r2'] / summary_stats['all'].keys()|length %}
    {% endif %}
    <tr>
      <td>{{lane}}</td>
      <td>{{run_data.lanes[lane]['projects']|join(", ")}}</td>
      <td>{{"{:,.2f}".format(phix)}}</td>
      <td>{{"{:,.2f}".format(occ)}}</td>
      <td>{{"{:,.2f}".format(yield_r1)}} <small>(Expected : {{expected_yield_r1}})</small></td>
      {% if yield_r2 %}
      <td>{{"{:,.2f}".format(yield_r2)}} <small>(Expected : {{expected_yield_r2}})</small></td>
      {% else %}
      <td></td>
      {% endif %}
      <td>{{"{:,.2f}".format(q30_r1)}}</td>
      {% if q30_r2 %}
      <td>{{"{:,.2f}".format(q30_r2)}}</td>
      {% else %}
      <td></td>
      {% endif %}

    </tr>
  {% endfor %}
</table>
{% endif %}

{% if 'total_reads' in conversion_stats and conversion_stats.total_reads %}
{% set first_lane = conversion_stats.samples|first%}
{% set first_sample = conversion_stats.samples[first_lane]|first %}
<h3>Demultiplexing Summary</h3>
<table class='useq_table'>
<tr> <td><b>Output (filtered) / Output (expected)</b></td> <td>{{nr_reads}}</td> </tr>
</table>
<br>
<table class='useq_table'>
  <tr>
    <th><b>Lane</b></th>
    <th><b>ProjectID</b></th>
    <th><b>M Reads</b></th>
  </tr>
  {% for lane, lane_data in run_data.lanes.items() %}
    {% for pid in lane_data.projects %}
      <tr>
        <td>{{ lane }}</td>
        <td>{{ pid }}</td>
        {% if lane in conversion_stats.total_reads_lane_project and pid in conversion_stats.total_reads_lane_project[lane] %}
        <td>{{"{:,.2f}".format(conversion_stats.total_reads_lane_project[lane][pid]/1000000) }}</td>
        {% endif %}
      </tr>
    {% endfor %}
    <tr>
      <td><b>{{ lane }}</b></td>
      <td><b>Total</b></td>
      {% if lane in conversion_stats.total_reads_lane %}
      <td><b>{{"{:,.2f}".format(conversion_stats.total_reads_lane[lane]/1000000) }}</b></td>
      {% endif %}
    </tr>
    <tr>
        <!-- <td colspan="4"></td> -->
        <td style="visibility: hidden;border: 0px" colspan="4"></td>
    </tr>
  {% endfor %}
</table>
<br>

<h3>Samples</h3>
<table class='useq_table'>
  <tr>
    <th style="visibility: hidden;border: 0px" colspan="6"></th>
    <!-- <th colspan="2"><b>% Index</b></th> -->
    {% if 'Read 2 Mean Quality Score (PF)' in conversion_stats.samples[first_lane][first_sample] %}
      <th colspan="2"><b>Mean Quality Score (PF)</b></th>
      <th colspan="2"><b>% Q30</b></th>
    {% else %}
      <th colspan="1"><b>Mean Quality Score (PF)</b></th>
      <th colspan="1"><b>% Q30</b></th>
    {% endif %}
  </tr>
  <tr>
    <th><b>Lane</b></th>
    <th><b>ProjectID</b></th>
    <th><b>SampleID</b></th>
    <th><b>Index</b></th>
    <th><b>M Reads</b></th>
    <th style="width:150px"><b>% Perfect Index</b></th>
    <!-- <th><b>1 Mismatch</b></th> -->

    {% for read_nr in ['1','2'] -%}
      {% if 'Read '+read_nr+' Mean Quality Score (PF)' in conversion_stats.samples[first_lane][first_sample] %}
        <th><b>Read {{read_nr}} </b></th>
      {% endif %}
    {% endfor %}
    {% for read_nr in ['1','2'] -%}
      {% if 'Read '+read_nr+' % Q30' in conversion_stats.samples[first_lane][first_sample] %}
        <th><b>Read {{read_nr}}</b></th>
      {% endif %}
    {% endfor %}
  </tr>

  {% for lane in conversion_stats.samples %}

    {% for sample_name in conversion_stats.samples[lane] %}

    {% set sample = conversion_stats.samples[lane][sample_name] %}
    {% set perc_pindex = (sample['# Perfect Index Reads'] / sample['# Reads']) * 100 if sample['# Reads'] else 0 %}
    {% set perc_of_total = (sample['# Reads'] / conversion_stats.total_reads) * 100 if conversion_stats.total_reads else 0 %}
    {% if perc_pindex <= 80 %}
      {% set perc_pindex_color = color_list1[0] %}
    {% else %}
      {% set perc_pindex_color = color_list1[1] %}
    {% endif %}

    {% set perc_of_total_color = color_list1[1] %}
    <tr>
      <td>{{ lane }}</td>
      <td>{{ sample['ProjectID'] }}</td>
      <td>{{ sample['SampleID'] }}</td>
      <td>{{ sample['Index'] }}</td>
      <td >
        <div class="" style="width:{{perc_of_total}}px; background-color:{{perc_of_total_color}}; position:relative;float:left;">&nbsp</div>
        <div style="position:relative; float:right;">{{ "{:,.2f}".format(sample['# Reads']/1000000) }}</div>

      </td>
      <td >

        <div class="" style="width:{{perc_pindex}}px; background-color:{{perc_pindex_color}}; position:relative;float:left;">&nbsp</div>
        <div style="position:relative; float:right;">{{ "{:,.2f}".format(perc_pindex) }}</div>

      </td>

      {% for read_nr in ['1','2'] -%}
        {% if 'Read '+read_nr+' Mean Quality Score (PF)' in sample -%}
          {% if sample['Read '+read_nr+' Mean Quality Score (PF)'] <30 %}
            {% set mqs_color = color_list1[0] %}
          {% else %}
            {% set mqs_color = color_list1[1] %}
          {% endif %}
          <td style="">
            <span style="position:relative; float:left;background-color:{{mqs_color}};"class="dot"></span>
            <div style="position:relative; float:right;">{{ "{:,.2f}".format(sample['Read '+read_nr+' Mean Quality Score (PF)']) }}</div>
          </td>
        {% endif %}
      {% endfor %}
      {% for read_nr in ['1','2'] -%}
        {% if 'Read '+read_nr+' % Q30' in sample -%}
          {% if sample['Read '+read_nr+' % Q30'] <80 %}
            {% set q30_color = color_list1[0] %}
          {% else %}
            {% set q30_color = color_list1[1] %}
          {% endif %}

          <td>
            <span style="position:relative; float:left;background-color:{{q30_color}};"class="dot"></span>
            <div style="position:relative; float:right;"> {{ "{:,.2f}".format(sample['Read '+read_nr+' % Q30']) }}</div>
          </td>
        {% endif %}
      {% endfor %}

    </tr>

    {% endfor %} <!--samples loop -->
  {% endfor %} <!--lanes loop -->
</table>
<br>
<h3>Top Unknown Barcodes</h3>
<table class='useq_table'>
  <tr>
    <th><b>Lane</b></th>
    <th><b>index</b></th>
    <th><b>index2</b></th>
    <th><b># Reads</b></th>
  </tr>
  {% for lane in conversion_stats['top_unknown'] %}
    {% for unk in conversion_stats['top_unknown'][lane] %}
    <tr>
      <td>{{ lane }}</td>
      <td>{{ unk['index'] }}</td>
      {% if 'index2' in unk %}<td>{{ unk['index2'] }}</td>{% endif %}
      <td>{{ unk['# Reads'] }}</td>
    </tr>
    {% endfor %}
  {% endfor %}
</table>
<br>
{% endif %}
<h3>Plots</h3>
<table>
  <tr>
    <td><img src='cid:flowcell_intensity_plot'></td>
    <td><img src='cid:clusterdensity_by_lane_plot'></td>
  </tr>
  <tr>
    <td><img src='cid:q_histogram_plot'></td>
    <td><img src='cid:q_heatmap_plot'></td>
  </tr>
  <tr>
    <td><img src='cid:basepercent_by_cycle_plot'></td>
    <td><img src='cid:intensity_by_cycle_plot'></td>
  </tr>
</table>
<h3>Logs</h3>
{{log | replace("\n", "<br>")}}
<br>
{% endblock %}
