{% extends "useq_mail_template.html" %}
{% block content %}
<p>Sequencing-run ID {{ project_id }} has succesfully been sequenced. </p>
<p>You can download your data using <a href="https://{{ nextcloud_host }}/index.php/s/{{ share_id }}">this</a> link.</p>
<p>Alternatively you can use this commandline argument to download the individual files in the shared directory:</p>
<p>curl -u '{{ share_id }}:PASSWORD' -H 'X-Requested-With: XMLHttpRequest' 'https://{{ nextcloud_host }}/public.php/webdav/FILENAME.tar' -o FILENAME.tar</p>
<p>Or to download all files sequentially, download the available_files.txt file attached to this email and execute the following command:</p>
<p>while read file; do curl -u '{{ share_id }}:PASSWORD' -H 'X-Requested-With: XMLHttpRequest' 'https://ncie01.op.umcutrecht.nl/public.php/webdav/'$file -o $file; done < /path/to/available_files.txt</p>
<p>For a list of available files, please look at the bottom of this email.</p>
<p>The password for this link will be send by sms to: {{ phone }}.</p>
<p>This link will remain active for 14 days. If you're unable to download your data within this period, please let us know.
Please also be aware that we're able to store your sequencing data for a maximum of two months, after which it is automatically deleted from our servers.</p>

<h3>Sample/Pool Measurements</h3>
{% if sample_measurements %}
<table class='useq_table'>
  {% if not sample_measurements.pool %}
    <tr>
      <th><b>Sample</b></th>
      <th><b>Isolated conc. (ng/ul)</b></th>
      <th><b>Pre library prep conc. (ng/ul)</b></th>
      <th><b>RIN</b></th>
      <th><b>Post library prep conc. (ng/ul)</b></th>
    </tr>
      {% for sample in sample_measurements.samples %}
        <tr>
          <td>{{sample}}</td>
          {% if sample_measurements.samples[sample]['Isolated conc. (ng/ul)'] %}
          <td>{{sample_measurements.samples[sample]['Isolated conc. (ng/ul)']}}</td>
          {% else %}
          <td>NA</td>
          {% endif %}
          {% if sample_measurements.samples[sample]['Pre library prep conc. (ng/ul)'] %}
          <td>{{sample_measurements.samples[sample]['Pre library prep conc. (ng/ul)']}}</td>
          {% else %}
          <td>NA</td>
          {% endif %}
          {% if sample_measurements.samples[sample]['RIN'] %}
          <td>{{sample_measurements.samples[sample]['RIN']}}</td>
          {% else %}
          <td>NA</td>
          {% endif %}
          {% if sample_measurements.samples[sample]['Post library prep conc. (ng/ul)'] %}
          <td>{{sample_measurements.samples[sample]['Post library prep conc. (ng/ul)']}}</td>
          {% else %}
          <td>NA</td>
          {% endif %}

        </tr>
      {% endfor %}
  {% else %}
    <tr>
      <th><b>Library conc. (ng/ul)</b></th>
      <th><b>Average length (bp)</b></th>
    </tr>
    <tr>
      <td>{{sample_measurements.pool['Library conc. (ng/ul)']}}</td>
      <td>{{sample_measurements.pool['Average length (bp)']}}</td>
    </tr>
  {% endif %}
</table>
{% endif %}
<h3>Sequencing Stats</h3>
{% if conversion_stats %}
<table class='useq_table'>
  <tr>
    <th><b>SampleID</b></th>
    <th><b>Index</b></th>
    <th><b># Reads</b></th>
    <th><b># Perfect Index Reads</b></th>
    <th><b># One Mismatch Index Reads</b></th>
    <!-- f'Read {row['ReadNumber']} Mean Quality Score (PF)' -->
    {% for read_nr in ['1','2','I1','I2'] -%}
      {% if 'Read '+read_nr+' Mean Quality Score (PF)' in conversion_stats.samples[0] %}
        <th><b>Read {{read_nr}} Mean Quality Score (PF)</b></th>
      {% endif %}
      {% if 'Read '+read_nr+' % Q30' in conversion_stats.samples[0] %}
        <th><b>Read {{read_nr}} % Q30</b></th>
      {% endif %}
    {% endfor %}
  </tr>


  {% for sample in conversion_stats.samples %}
  <tr>
    <td>{{ sample['SampleID'] }}</td>
    <td>{{ sample['Index'] }}</td>
    <td>{{ "{:,.0f}".format(sample['# Reads']) }}</td>
    <td>{{ "{:,.0f}".format(sample['# Perfect Index Reads']) }}</td>
    <td>{{ "{:,.0f}".format(sample['# One Mismatch Index Reads']) }}</td>
    {% for read_nr in ['1','2','I1','I2'] -%}
      {% if 'Read '+read_nr+' Mean Quality Score (PF)' in sample -%}
        <td>{{ "{:,.2f}".format(sample['Read '+read_nr+' Mean Quality Score (PF)']) }}</td>
      {% endif %}
      {% if 'Read '+read_nr+' % Q30' in sample -%}
        <td>{{ "{:,.2f}".format(sample['Read '+read_nr+' % Q30']) }}</td>
      {% endif %}
    {% endfor %}

  </tr>
  {% endfor %}
</table>
{% else %}
<p>NA</p>
{% endif %}
<h3>Available files</h3>
<ol>
{% for file in file_list %}
  <li>{{file}}</li>
{% endfor %}
</ol>
{% endblock %}
